<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GodotGameAssembler</title>
<style>
  body { font-family: sans-serif; margin:0; padding:0; background:#1e1e1e; color:#f0f0f0; }
  header { background:#282c34; padding:1em; text-align:center; font-size:1.5em; }
  #container { display:flex; flex-wrap:wrap; padding:1em; gap:1em; }
  .panel { background:#2b2b2b; padding:1em; border-radius:8px; flex:1; min-width:300px; max-width:600px; }
  button { margin-top:0.5em; padding:0.5em 1em; font-size:1em; border:none; border-radius:4px; cursor:pointer; }
  input, select, textarea { width:100%; margin-top:0.5em; padding:0.5em; border-radius:4px; border:none; }
  #nlp-interface { height:150px; overflow-y:auto; background:#1b1b1b; padding:0.5em; border-radius:4px; }
</style>
</head>
<body>
<header>GodotGameAssembler</header>

<div id="container">
  <!-- Scene & Node Manager -->
  <div class="panel" id="scene-manager">
    <h3>Scenes & Nodes</h3>
    <input type="text" id="scene-name" placeholder="Scene name">
    <button onclick="addSceneGUI()">Add Scene</button>
    <div id="scene-list"></div>
    <hr>
    <input type="text" id="node-name" placeholder="Node name">
    <select id="node-type">
      <option>Node2D</option>
      <option>Sprite</option>
      <option>Label</option>
      <option>Control</option>
      <option>Area2D</option>
      <option>Camera2D</option>
    </select>
    <input type="text" id="parent-name" placeholder="Parent node (optional)">
    <button onclick="addNodeGUI()">Add Node</button>
    <div id="node-list"></div>
  </div>

  <!-- Asset Manager -->
  <div class="panel" id="asset-manager">
    <h3>Assets</h3>
    <input type="file" id="asset-upload" multiple>
    <select id="asset-type">
      <option value="texture">Texture</option>
      <option value="gltf">GLTF Model</option>
      <option value="audio">Audio</option>
      <option value="font">Font</option>
    </select>
    <button onclick="uploadAssetsGUI()">Upload Asset(s)</button>
    <ul id="asset-list"></ul>
  </div>

  <!-- Project Export -->
  <div class="panel" id="export-panel">
    <h3>Export Project</h3>
    <input type="text" id="project-name" placeholder="Project Name">
    <button onclick="generateProjectGUI()">Generate & Download ZIP</button>
    <div id="export-status"></div>
  </div>

  <!-- NLP Interface -->
  <div class="panel" id="nlp-panel">
    <h3>NLP Interface</h3>
    <div id="nlp-interface"></div>
    <input type="text" id="nlp-command" placeholder="Type command here">
    <button onclick="sendNLPCommandGUI()">Send</button>
  </div>
</div>

<!-- Local Libraries -->
<script src="libs/jszip.min.js"></script>
<script src="libs/FileSaver.min.js"></script>
<script src="godot.js"></script>

<script>
  // --- GUI functions connecting to Godot backend ---

  function addSceneGUI() {
    const name = document.getElementById("scene-name").value.trim();
    if(!name) return alert("Enter scene name");
    ProjectManager.add_scene(name);
    document.getElementById("scene-list").innerHTML += `<div>${name}</div>`;
    appendNLP(`Scene '${name}' added.`);
  }

  function addNodeGUI() {
    const nodeName = document.getElementById("node-name").value.trim();
    const nodeType = document.getElementById("node-type").value;
    const parent = document.getElementById("parent-name").value.trim();
    const sceneList = document.getElementById("scene-list").children;
    if(sceneList.length === 0) return alert("Add a scene first");
    const sceneName = sceneList[sceneList.length-1].innerText;
    ProjectManager.add_node(sceneName, nodeName, nodeType, parent);
    document.getElementById("node-list").innerHTML += `<div>${nodeName} (${nodeType})</div>`;
    appendNLP(`Node '${nodeName}' of type '${nodeType}' added to scene '${sceneName}'.`);
  }

  function uploadAssetsGUI() {
    const files = document.getElementById("asset-upload").files;
    const type = document.getElementById("asset-type").value;
    const list = document.getElementById("asset-list");
    if(files.length === 0) return alert("Select files to upload");

    for(let file of files){
      const reader = new FileReader();
      reader.onload = (e) => {
        const arrayBuffer = e.target.result;
        ProjectManager.upload_asset(file.name, type, arrayBuffer);
        list.innerHTML += `<li>${file.name} (${type})</li>`;
        appendNLP(`Asset '${file.name}' uploaded as ${type}.`);
      };
      reader.readAsArrayBuffer(file);
    }
  }

  async function generateProjectGUI() {
    const projectName = document.getElementById("project-name").value.trim() || "GodotProject";
    const status = document.getElementById("export-status");
    status.innerText = "Generating project ZIP...";
    appendNLP(`Generating project '${projectName}'...`);

    const zip = new JSZip();

    // --- Add Scenes & Scripts ---
    const scenes = ProjectManager.get_scenes(); // Implement in GDScript singleton
    for (const sceneName in scenes) {
      const scene = scenes[sceneName];
      const tscnContent = ProjectManager.get_scene_file(sceneName);
      zip.file(`${projectName}/${sceneName}.tscn`, tscnContent);
      for (const scriptName in scene.scripts) {
        const code = scene.scripts[scriptName];
        zip.file(`${projectName}/scripts/${scriptName}.gd`, code);
      }
    }

    // --- Add Assets ---
    const assets = ProjectManager.list_assets(); // {filename: {type, data}}
    for (const assetName in assets) {
      const asset = assets[assetName];
      zip.file(`${projectName}/assets/${assetName}`, asset.data);
    }

    // --- Add Made-by Slide ---
    const introScene = `[node name="MadeByIntro" type="Label" parent=""]\ntext = "Made with GodotGameAssembler by CCVO"\n`;
    zip.file(`${projectName}/MadeByIntro.tscn`, introScene);

    // --- Generate ZIP and trigger download ---
    const content = await zip.generateAsync({ type: "blob" });
    saveAs(content, `${projectName}.zip`);
    status.innerText = `Project '${projectName}' ZIP ready for download.`;
    appendNLP(`Project '${projectName}' generated and ready for download.`);
  }

  function sendNLPCommandGUI() {
    const cmd = document.getElementById("nlp-command").value.trim();
    if(!cmd) return;
    appendNLP(`> ${cmd}`);
    document.getElementById("nlp-command").value = "";
    const response = ProjectManager.process_nlp_command(cmd);
    appendNLP(response);
  }

  function appendNLP(message) {
    const panel = document.getElementById("nlp-interface");
    panel.innerHTML += `<div>${message}</div>`;
    panel.scrollTop = panel.scrollHeight;
  }

  // Initialize Godot Runtime (assumes instance is available)
  let godotInstance = null; // Replace with your Godot HTML5 export instance
  if(window.godotInstance) initGodotRuntime(window.godotInstance);

</script>
</body>
</html>